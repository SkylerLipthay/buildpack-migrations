#!/usr/bin/env bash

#Heroku passes in these arguments
current_path=$0
build_dir=$1
cache_dir=$2
env_dir=$3

#Load environment variables that may be needed to boot rails.
if [ -d "$env_dir" ]; then
  blacklist_regex=${4:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
  for e in $(ls -1 $env_dir | grep -vE "$blacklist_regex"); do
    echo "export $e=$(cat $env_dir/$e)"
    export "$e=$(cat $env_dir/$e)"
  done
fi

migrations_done=(`psql ${DATABASE_URL} --command="SELECT * FROM schema_migrations ORDER BY version DESC" --tuples-only`)

known=(`ls ${build_dir}/db/migrate`)

run_migrations=false

for i in "${known[@]}"; do
  num=`echo ${i} | awk -F "_" '{print $1}'`
  if  ! [[ " ${migrations_done[@]} " =~ " ${num} " ]]; then
    run_migrations=true
  fi
done

if [[ run_migrations -eq true ]]
then
cd $build_dir && \
  bundle exec rake db:migrate
  if [ $? -eq 1 ]
  then
    echo "There was an error running migrations. Deploy halted."
    exit 1
  fi
else
  echo "Not running migrations. No pending migrations found."
fi
