#!/usr/bin/env bash

set -o #exit codes on pipe

#Heroku passes in these arguments
current_path=$0
build_dir=$1
cache_dir=$2
env_dir=$3

db_url=`cat ${3}/DATABASE_URL`
latest_version=`psql ${db_url} --command="SELECT * FROM schema_migrations ORDER BY version DESC LIMIT 1" --tuples-only`
latest_migration=`echo ${latest_version} | awk -F "_" '{print $1}' | tail -n 1`

if [ ${latest_migration} -gt ${latest_version} ]
then
cd $build_dir && \
  RACK_ENV=`cat ${3}/RACK_ENV` \
  DATABASE_URL=`cat ${3}/DATABASE_URL` bundle exec rake db:migrate
fi
